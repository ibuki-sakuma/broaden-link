# AWSサービス運用停止・再開手順
本ドキュメントは、本プロジェクトで使用しているAWSサービスの運用を一時的に停止し、その後問題なく再開するための手順をまとめたものです。

# 対象のAWSサービス
1. Webアプリ用EC2インスタンス (ECS on EC2環境)
2. RDS (Relational Database Service) ※一時的な停止のため**7日間**で再起動される
3. NATインスタンス
4. Network Load Balancer (NLB)

# 対象外のAWSサービス
以下のサービスに関して、運用コストが少ないため対象外としています。

- **Amazon Cognito**:
    - Liteティアは月10,000 MAUまで無料で、今回の規模では課金なし。
    - メール認証はEC2経由のSES送信で月62,000通まで無料。
    - SMS認証や高RPSオプションを使わなければ追加料金なし。
    - 数か月運用しても**総額ほぼ0円**で収まる想定。
- **ECR (Elastic Container Registry)**: 
    - ECRの課金は月平均の保存容量に対して発生し、単価は0.10 USD/GB/月。
        - イメージ350MB×1個なら約5円/月、4個保持しても1か月続けば約20円/月程度。
        - 15時間ごとに削除（ライフサイクルポリシー）されるなら平均容量は小さくなり、実際の**月額は数円〜10円弱**に収まる想定。
    - 同一リージョン内でのECSからのPullやECRへのPushはデータ転送無料で追加料金は発生しない。
- **Secrets Manager**:
    - シークレット数: 1件のみ
    - 保存料: シークレット1件あたり 0.40 USD/月
    - APIコール: EC2起動時に1回取得、月30回程度 → 10,000回あたり0.05 USDなので料金ほぼゼロ
    - 月額合計: **約0.40 USD（60円前後）**で、EC2起動ごとの取得コストもほぼ無視可能
- **Route 53**:
    - ホストゾーン1件: 0.50 USD/月
    - レコード8件: 10,000件以下のため追加料金なし
    - DNSクエリ1万件/月程度なら 0.004 USD/月（ほぼ無視できるレベル）
    - 数か月運用でも総額、約1〜2USD程度
- **ドメイン購入 (Route 53経由)**:
    - ドメイン料金: 約1,500円/年（延長はオフ）
    - Route 53のホストゾーンとは別で、単純にドメイン登録料として課金
    - 数か月運用なら追加費用なし
- **Certificate Manager**:
    - HTTPS用のSSL/TLS証明書の発行: 無料
- **CloudWatch**:
    - CloudWatchの基本メトリクスやログ取り込みは、標準利用枠（ログ5GB/月、メトリクス10個、APIリクエスト100万件）内なら常に無料。
    - あなたの環境（少量ログ、標準EC2/RDSモニタリング）では、無料枠でほぼ全カバー可能。
    - Live Tail や Logs Insights も少量使用なら追加料金なし。
    - 数か月運用程度の低規模サービスなら、CloudWatch費用はほぼ0円。
    - ログの保持期間を1か月に設定。
- **S3 Bucket**:
    - ストレージ料金: ファビコン程度の小容量なら月数円程度でほぼ無視できる。
    - リクエスト料金: PUTは1,000件あたり0.005 USD、GETは1,000件あたり0.0004 USD。1日100件程度の利用でも月数銭程度でほぼ0円。
    - データ転送: 同一リージョン内のEC2からのアクセスは無料。
    - その他: ライフサイクル移行やアーカイブ（GlacierやDeep Archiveなど）を使わなければ追加料金なし。
- **VPC(Subnet, Security Group, Route Table)**:
    - VPC、サブネット、セキュリティグループ、ルートテーブルの構築は無料。
    - 基本的なネットワーク構成はコストゼロで利用可能。
- **VPC Endpoint(Gateway)**:
    - S3用ゲートウェイ型VPCエンドポイントは 作成・維持費無料
    - 同一リージョン内のS3アクセスでは データ転送も無料
    - エンドポイント自体に料金はかからず、S3リクエスト料金のみ発生
- **ネットワークインターフェイス（ENI）**:
    - 作成済みのENI自体は料金発生なし。
    - Elastic IPを割り当てていなければ追加費用なし。

# 各AWSサービスの停止手順
## 1. Webアプリ用EC2インスタンス (ECS on EC2環境)
ECS on EC2環境でWebアプリ用EC2インスタンスを停止する際は、以下の手順でECSタスクを安全に停止し、インスタンスを切り離す。

1. **ECSサービスのタスク数を0にスケールダウンする**:
    - 対象のECSサービスが稼働している場合、そのサービスの希望タスク数を0に設定する。
    - これにより、サービスによって管理されているタスクが安全に停止される。
    - **AWSマネジメントコンソールでの手順**:
        - ECSサービスを選択し、「サービスを更新」から「必要なタスク」を`0`に変更して「更新」ボタンを押下。
        - 「ロードバランシング」オプションはそのまま。（タスク数0だから、自動的にターゲットの登録を解除されるため）
        - 「停止済み」になるまで時間がかかるため注意。
    - **AWS CLIコマンド例**:
        - <検証後に追記>

2. **EC2インスタンスを削除する**:
    - 上記の手順でタスクが停止し、コンテナインスタンスがドレインされたことを確認した後、EC2インスタンスを削除する。
    - **AWSマネジメントコンソールでの手順**:
        - EC2>Auto Scalingグループから対象のグループを選択→アクション>編集を押下。
        - 以下を設定後、「更新」ボタンを押下。
            - 「希望するキャパシティ」を`0`に設定。
            - 「スケーリング制限」から、「最小の希望する容量」と「最大の希望する容量」を`0`に設定する。
    - **AWS CLIコマンド例**:
        - <検証後に追記>

## 2. Network Load Balancer (NLB)
NLBの利用料金を完全に停止するために、NLB自体を削除する。関連する設定が一部削除される可能性があるため注意。

1. **Network Load Balancerを削除する**:
    - AWSマネジメントコンソールまたはAWS CLIを使用して、対象のNLBを削除する。
    - **AWSマネジメントコンソールでの手順**:
        - ロードバランサから当該NLBを選択後、「アクション」>「ロードバランサの削除」を押下。
        - ポップアップで「確認」を入力後、「削除」ボタンを押下。
    - **AWS CLIコマンド例**:
        - <検証後に追記>

## 3. RDS (Relational Database Service)
データ保持もあるため、削除ではなく停止を実行する。
※長期間停止させる時のために、スナップショットを利用した再作成手順も知るべき。

1. **RDSインスタンスの停止**:
    - AWSマネジメントコンソールまたはAWS CLIで、停止している対象のRDSインスタンスを停止する。
    - **AWSマネジメントコンソールでの手順**:
        - RDSで対象DBに遷移して、アクション>一時的に停止を押下。
        - 以下の設定後、「一時的に停止」ボタンを押下。
            - 表示されたポップアップから「了承する」と「スナップショット」にチェックを入れる。
            - 「スナップショット名」を決める。（例:`<project>-db-stop-20250814`）
    - **AWS CLIコマンド例**:
        - <検証後に追記>
    - **注意**:
        - 7日が経過すると、AWSによってDBインスタンスが自動的に再起動する。
        - RDSインスタンスの停止には時間がかかる場合がある。

## 4. NATインスタンス
対象のEC2インスタンスは、特定の管理サービスに依存しない一般的なインスタンスであるため、停止のみを実行する。
※EBSの料金はEC2インスタンスの停止/削除とは独立して料金がかかる。

1. **対象のNATインスタンスを停止する**:
    - AWSマネジメントコンソールやAWS CLIで、対象のNATインスタンスを停止する。
    - **AWSマネジメントコンソールでの手順**:
        - EC2>インスタンスから対象のインスタンスを選択後、「インスタンスの状態」から「インスタンスを停止」を押下。
        - ポップアップから「停止」ボタンを押下。
    - **AWS CLIコマンド例**:
        - <検証後に追記>

# 各AWSサービスの再開手順
## 1. NATインスタンス
EC2インスタンスを停止しているだけなので、起動のみを実行する。

1. **対象のNATインスタンスを起動する**:
    - AWSマネジメントコンソールやAWS CLIで、対象のNATインスタンスを起動する。
    - **AWSマネジメントコンソールでの手順**:
        - EC2>インスタンスから対象のインスタンスを選択後、「インスタンスの状態」から「インスタンスを開始」を押下。
        - ステータスチェックが「3/3のチェックに合格しました」になるまで待つ。
    - **AWS CLIコマンド例**:
        - <検証後に追記>

## 2. RDS (Relational Database Service)
「一時的な停止」の場合、「開始」するだけ。

1. **RDSインスタンスの開始**:
    - AWSマネジメントコンソールまたはAWS CLIで、停止している対象のRDSインスタンスを開始する。
    - **AWSマネジメントコンソールでの手順**:
        - RDSで対象DBに遷移して、アクション>開始を押下。
    - **AWS CLIコマンド例**:
        - <検証後に追記>
    - **注意**:
        - RDSインスタンスの起動には時間がかかる場合がある。
        - 起動後、アプリケーションからの接続を確認する。

## 3. Network Load Balancer (NLB)
NLBの作成だけでなく関連するサービスとの設定も実施する必要がある。

1. **Network Load Balancerを作成する**:
    - AWSマネジメントコンソールまたはAWS CLIを使用して、NLBを作成する。
    - **AWSマネジメントコンソールでの手順**:
        - ロードバランサから「ロードバランサの作成」を押下。
        - 以下の設定を入力し、「ロードバランサの作成」ボタンを押下。
            - 「Network Load Balancer」で作成。
            - ロードバランサ名: `<project>-nlb`
            - スキーム: インターネット向け
            - ロードバランサーの IP アドレスタイプ: IPv4
            - ネットワークマッピング
                - VPC: `<project>-vpc`
                - AZ: `ap-northeast-1a`
                - subnet: `<project>-vpc-subnet-public1-ap-northeast-1a`
                - IPv4 アドレス: AWS によって割り当て済み
            - セキュリティグループ: `<project>-nlb-sg`
            - リスナーとルーティング: TLS, 443, デフォルトアクション: `<project>-tg`
            - セキュアリスナーの設定: ACMから, 当該証明書の選択, その他デフォルト設定
            - タグ: `Project`, `<project>`
    - **AWS CLIコマンド例**:
        - <検証後に追記>

2. **Route 53で当該ホストゾーンにレコードの追加**:
    - ドメイン取得時に作成した2つのレコードを再設定する。
    - **AWSマネジメントコンソールでの手順**:
        - Route 53を開き、ホストゾーンから当該ホストゾーンを選択。
        - NLBをトラフィックのルーティング先にしているレコードに対して、作成したNLBで再設定する。（x2）
    - **AWS CLIコマンド例**:
        - <検証後に追記>

3. **ECSサービスのオプションでNLBを設定する**:
    - ECSサービスの「ロードバランシング」オプションで設定する。（そのためセクション4のタイミングで実施）
    - **AWSマネジメントコンソールでの手順**:
        - 「ロードバランシングを使用」をチェック。
        - VPC: `<project>-vpc`
        - ロードバランサーの種類: Network Load Balancer
        - コンテナ: 初期値
        - ロードバランサー: `<project>-nlb`（作成したNLB）
        - リスナー: 「TLS:443」
        - ターゲットグループ: `<project>-tg`
    - **AWS CLIコマンド例**:
        - <検証後に追記>

## 4. Webアプリ用EC2インスタンス (ECS on EC2環境)
ECS on EC2環境でWebアプリ用EC2インスタンスを起動する際は、以下の手順でECSタスクを安全に起動する。

1. **EC2インスタンスを起動する準備**:
    - EC2インスタンスが作成されるようにAuto Scaling設定を元に戻す。
    - **AWSマネジメントコンソールでの手順**:
        - EC2>Auto Scalingグループから対象のグループを選択→アクション>編集を押下。
        - 以下を設定後、「更新」ボタンを押下。
            - 「希望するキャパシティ」を`1`に設定。
            - 「スケーリング制限」から、「最小の希望する容量」と「最大の希望する容量」を`1`に設定する。
    - **AWS CLIコマンド例**:
        - <検証後に追記>

2. **ECSサービスのタスク数を1にスケールアップする**:
    - 対象のECSサービスが稼働している場合、そのサービスの希望タスク数を1に設定する。
    - これにより、サービスによって管理されているタスクが起動される。
    - **AWSマネジメントコンソールでの手順**:
        - ECSサービスを選択し、「サービスを更新」から「必要なタスク」を`1`に変更して「更新」ボタンを押下。
        - **「ロードバランシング」オプションを設定**する。（手順はセクション3の手順を参照）
        - タスクが「実行中」になるまで待機する。
        - ターゲットグループが「Healthy」になるまで時間がかかるため注意。
    - **AWS CLIコマンド例**:
        - <検証後に追記>

## 5. 接続の確認
- ECS>タスクを選択後、「ログ」タブを見て起動ログ（CloudWatch）があるか確認する。
- 設定したレコードのURLでアクセスできる（Route 53）ことを確認する。
- ログイン（Cognito）できることを確認する。
- ブックマークリストが表示される（RDS）ことを確認する。
- ファビコンが表示される（S3）ことを確認する。
- ページタイトルが取得できる（NATインスタンス経由）ことを確認する。